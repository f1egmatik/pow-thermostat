# pow-thermostat
Heater/cooler controlling system with 2 devices: esp32 based Sonoff Pow Origin/Elite smart relay and Xiaomi Mijia temperature sensor

[ru] Система управления обогревом/охлаждением помещения из двух устройств: умного реле Sonoff Pow Origin/Elite и термогигрометра Xiaomi Mijia

# Предыстория 
После установки в новой квартире симпатчного датчика температуры и влажности от Xiaomi появилась идея привязать его к какой-нибудь умной розетке на базе esp32, которая бы включала-выключала электрический обогреватель по мере необходимости. В имеющемся у меня конвекционном обогревателе есть аналоговый термостат, но он измеряет температуру непосредственно внутри нагревательного прибора, из-за чего конечная температура воздуха в один (тёплый) день может удерживаться на уровне 23 градуса, а в другой (холодный) на уровне 21 градус. Установка датчика температуры в другом конце помещения даст лучший контроль за уровнем комфортной температуры. 

Особый шарм задумке придаёт тот факт, что оба устройства выпускаются промышленно и находятся в корпусах от заводов-производителей и привлекательно выглядят, а не собираются на макетных платах. Причём для совместной работы этих двух устройств не потребуется промежуточный хаб или сервер, скажем, home assistant. Достаточно прошить esphome в умную розетку. 

# Розетки на базе esp32
Ринувшись на поиски умных розеток, я с разочарованием обнаружил, что все они делаются на базе дешёвой системы esp8266, у которой отсутствует bluetooth-модуль. Единственный производитель, который выпускает что-то на системе esp32 и похожее на розетки, это Sonoff. На конец 2022-го года у него была линейка из восьми устройств: 
POW/TH Origin/Elite 16/20. 

POW — реле с датчиками тока и напряжения и, соответственно, мощности, для них есть прошивки tasmota и esphome. 

TH — реле с внешним датчиком температуры и влажности (приобретается отдельно), для них свободных прошивок не видел. 

Origin — реле в простом прямоугольном корпусе с возможностью монтажа на din-рейку. 

Elite — к тому же корпусу приделан дисплей tm1621 (поддерживается в esphome). 

16 — реле на 16 А, управляется одним пином. 

20 — реле на 20 А, бистабильное, управляется двумя пинами, алгоритм управления имеется в esphome. 

Я не стал заморачиваться и для себя заказал самый простой и дешёвый вариант: POW Origin 16 (модель имеет идентификатор POWR316). Да, для подключения такого реле мне пришлось распороть удлинитель, из-за чего реализация выглядит уже не так симпатично как простая умная розетка. // Но и не так ужасно, как https://github.com/f1egmatik/aircontrol . 

# Заливка прошивки
Модели умных реле Sonoff на esp32 не поддерживают [DIY](https://cgomesu.com/blog/ota-tasmota-sonoff/) режим, позволяющий поменять заводскую прошивку на свою по воздуху через встроенный веб-сервер (в отличие от популярных моделей Basic R3 на esp8266). Поэтому для первоначальной прошивки esphome в Pow Origin или Pow Elite придётся вскрыть его и подключить usb-ttl конвертер к uart-контактам. Мне повезло в том, что у конвертора достаточно было отогнуть ножку +5V и остальные пины просто втыкались в дырочке на плате Pow Origin. Ещё мне повезло, что в моём конвертере есть защита и при неправильном подключении (воткнул ножки с другой стороны платы) устройство просто отключается.  

Выдавать права на мерцающий ttyUSB я не стал и прошивал не из dashboard'а, а рутом из командной строки. 

Все последующие изменения прошивки производятся "по воздуху" из панели управления esphome. 

# Контроль присутствия людей 
Поскольку в esp32 есть bluetooth-модуль, я решил задействовать его не только для получения температуры с внешнего датчика, но и для контроля присутствия в помещении людей. Можно контролировать присутствие как по обнаружению фитнес-трекеров, так и с помощью beacon-меток, создаваемых телефонами. Когда кто-то присутствует, система поддерживает "комфортный" уровень температуры. Если же никого не видно, то через 20 минут система переходит в "экономичный" режим, поддерживая более низкую температуру при обогреве. 

